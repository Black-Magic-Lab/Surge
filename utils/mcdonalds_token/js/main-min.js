import*as zip from"../node_modules/@zip.js/zip.js/index.js";const bplist=require("bplistParser.js");let reader;const checkHasFile=()=>{document.getElementById("fileInput").value&&document.getElementById("submitButton").removeAttribute("disabled")},handleSubmit=async e=>{if(e.preventDefault(),document.getElementById("result")){let e=document.getElementById("result");for(;e.firstChild;)e.removeChild(e.firstChild)}const t=await getTargetFile(document.getElementById("fileInput").files);if(!t)return void alert("失敗：找不到 tw.com.mcddaily.plist！");const n=await unzipFileData(t),r=await bplist.parseBuffer(n),a=decryptData(r);showToken(a)},getTargetFile=async e=>{const t=e[0];reader=new zip.ZipReader(new zip.BlobReader(t));const n=await reader.getEntries();let r;if(n.length)for(const e of n)if("Container/Library/Preferences/tw.com.mcddaily.plist"===e.filename){r=e;break}return r},unzipFileData=async e=>{try{const t=await e.getData(new zip.BlobWriter);return await t.arrayBuffer()}catch(e){return void alert("失敗：解壓縮失敗，檔案可能已損毀")}},decryptData=e=>{try{const t=CryptoJS.enc.Utf8.parse("1s2unxaounk8zusv"),n={words:[0,0,0,0],sigBytes:16,mode:CryptoJS.mode.ECB,pad:CryptoJS.pad.Pkcs7},r=CryptoJS.AES.decrypt(e[0].MCDUser,t,n).toString(CryptoJS.enc.Utf8);return JSON.parse(r).accessToken}catch(e){return void alert("失敗：無法找到 Token，可能檔案有誤")}},showToken=e=>{const t=document.createElement("p"),n=document.createElement("pre");t.textContent="請將 mcdonalds_set_token.js 的第一行換成以下內容，之後執行：",n.textContent="const token = '"+e+"';",document.getElementById("result").appendChild(t),document.getElementById("result").appendChild(n)};document.getElementById("fileInput").addEventListener("change",checkHasFile),document.getElementById("fileForm").addEventListener("submit",handleSubmit);